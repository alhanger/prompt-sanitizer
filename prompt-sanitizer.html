<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Sanitizer/Desanitizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #09121f 0%, #415169 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 520px 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .sidebar {
            background: #f3f7fc;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-content {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #71a9bf 0%, #597e93 100%);
            color: white;
            padding: 25px;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.85em;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .main-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .main-scroll.side-by-side {
            display: flex;
            flex-direction: column;
        }

        .main-scroll.side-by-side .io-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 12px;
            color: #09121f;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 18px;
            background: linear-gradient(135deg, #71a9bf 0%, #597e93 100%);
            border-radius: 2px;
        }

        .section-title.collapsable {
            cursor: pointer;
            user-select: none;
        }

        .section-title.collapsable:hover {
            opacity: 0.8;
        }

        .collapse-icon {
            margin-left: auto;
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsable-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }

        .collapsable-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0 !important;
        }

        .mapping-sets {
            margin-bottom: 20px;
        }

        .mapping-set-item {
            background: #ffffff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mapping-set-item:hover {
            background: #92bdcf;
            color: #ffffff;
        }

        .mapping-set-item.active {
            border-color: #71a9bf;
            background: #92bdcf;
            color: #09121f;
        }

        .mapping-set-name {
            font-weight: 500;
            flex: 1;
        }

        .mapping-set-count {
            font-size: 0.85em;
            opacity: 0.8;
            margin-right: 8px;
        }

        .btn-delete-set {
            background: #985fb9;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .btn-delete-set:hover {
            background: #7a4a94;
        }

        .new-set-form {
            margin-top: 15px;
            display: flex;
            gap: 8px;
        }

        .new-set-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .new-set-input:focus {
            outline: none;
            border-color: #71a9bf;
        }

        .btn-add-set {
            background: linear-gradient(135deg, #71a9bf 0%, #597e93 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn-add-set:hover {
            opacity: 0.9;
        }

        .mapping-editor {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .mapping-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .mapping-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .mapping-input:focus {
            outline: none;
            border-color: #71a9bf;
        }

        .arrow {
            color: #71a9bf;
            font-weight: bold;
        }

        .btn-remove-mapping {
            background: #985fb9;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .btn-remove-mapping:hover {
            background: #7a4a94;
        }

        .btn-add-mapping {
            background: #415169;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }

        .btn-add-mapping:hover {
            background: #334054;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #71a9bf;
        }

        .text-container {
            width: 100%;
            position: relative;
            resize: vertical;
            overflow: hidden;
            min-height: 240px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .text-display {
            width: 100%;
            height: 100%;
            min-height: 240px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: white;
            color: #000;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            border: none;
        }

        #inputDisplay {
            display: none;
        }

        .text-container textarea {
            border: none;
            border-radius: 0;
        }

        #outputDisplay {
            width: 100%;
            min-height: 240px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: white;
            color: #000;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
        }

        .highlight {
            background-color: #eaff03;
            color: #09121f;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .highlight.fade {
            animation: fadeOut 2s ease-in-out forwards;
        }

        @keyframes fadeOut {
            0% {
                background-color: #eaff03;
            }
            100% {
                background-color: transparent;
            }
        }

        .buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button:not(.btn-delete-set):not(.btn-add-set):not(.btn-remove-mapping):not(.btn-add-mapping) {
            padding: 12px 24px;
            font-size: 0.95em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        .btn-sanitize {
            background: linear-gradient(135deg, #71a9bf 0%, #597e93 100%);
            color: white;
        }

        .btn-sanitize:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(113, 169, 191, 0.4);
        }

        .btn-desanitize {
            background: linear-gradient(135deg, #985fb9 0%, #7a4a94 100%);
            color: white;
        }

        .btn-desanitize:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(152, 95, 185, 0.4);
        }

        .btn-clear {
            background: #415169;
            color: white;
        }

        .btn-clear:hover {
            background: #334054;
        }

        .btn-copy {
            background: #92bdcf;
            color: #09121f;
        }

        .btn-copy:hover {
            background: #71a9bf;
            color: white;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #71a9bf 0%, #597e93 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #71a9bf;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .sidebar {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar for Mapping Management -->
        <div class="sidebar">
            <div class="header">
                <h1>üìö Mapping Sets</h1>
                <p>Manage reusable mappings</p>
            </div>
            <div class="sidebar-content">
                <div class="section-title">Saved Sets</div>
                <div class="mapping-sets" id="mappingSets">
                    <!-- Mapping sets will be rendered here -->
                </div>

                <div class="new-set-form">
                    <input type="text" id="newSetName" class="new-set-input" placeholder="New set name...">
                    <button class="btn-add-set" onclick="createNewSet()">+ Add</button>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                    <div style="font-size: 0.9em; font-weight: 500; margin-bottom: 8px; color: #09121f;">Import from CSV</div>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                    <button class="btn-add-set" onclick="document.getElementById('csvFileInput').click()" style="width: 100%;">üìÅ Upload CSV</button>
                    <div style="font-size: 0.75em; color: #666; margin-top: 8px; line-height: 1.4;">
                        CSV format: Two columns (Original, Replacement) with optional header row
                    </div>
                </div>

                <div class="section" style="margin-top: 25px;">
                    <div class="section-title">Wildcard Options</div>
                    <div style="background: #ffffff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
                            <input type="checkbox" id="wildcardEmails" onchange="saveWildcardSettings()"
                                   style="width: 18px; height: 18px; cursor: pointer; accent-color: #71a9bf;">
                            <span style="font-weight: 500;">All Emails</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="wildcardPhones" onchange="saveWildcardSettings()"
                                   style="width: 18px; height: 18px; cursor: pointer; accent-color: #71a9bf;">
                            <span style="font-weight: 500;">All Phone Numbers</span>
                        </label>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title collapsable" onclick="toggleMappingsCollapse()">
                        Current Mappings
                        <span class="collapse-icon" id="mappingsCollapseIcon">‚ñº</span>
                    </div>
                    <div class="collapsable-content" id="mappingsCollapsableContent">
                        <button class="btn-add-mapping" onclick="addMapping()">+ Add Mapping</button>
                        <div class="mapping-editor" id="mappingEditor">
                            <!-- Mapping editor will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <div class="header">
                <h1>üîí Prompt Sanitizer/Desanitizer</h1>
                <p>Sanitize sensitive information or restore original text</p>
            </div>
            <div class="main-scroll" id="mainScroll">
                <div class="buttons">
                    <button class="btn-sanitize" onclick="sanitize()">üîí Sanitize</button>
                    <button class="btn-desanitize" onclick="desanitize()">üîì Desanitize</button>
                    <button class="btn-copy" onclick="copyOutput()">üìã Copy Output</button>
                    <button class="btn-clear" onclick="clearAll()">üóëÔ∏è Clear All</button>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 15px; margin-bottom: 20px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="persistHighlight" onchange="savePersistHighlightSetting()"
                               style="width: 18px; height: 18px; cursor: pointer; accent-color: #71a9bf;">
                        <span style="font-weight: 500; color: #09121f;">Persist Highlighting</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="sideBySideLayout" onchange="toggleLayout()"
                               style="width: 18px; height: 18px; cursor: pointer; accent-color: #71a9bf;">
                        <span style="font-weight: 500; color: #09121f;">Side-by-Side Layout</span>
                    </label>
                </div>

                <div class="io-container">
                    <div class="section">
                        <div class="section-title">Input Text</div>
                        <div class="text-container" id="inputContainer">
                            <div id="inputDisplay" class="text-display"></div>
                            <textarea id="inputText" rows="10" placeholder="Enter your text here..."></textarea>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">Output</div>
                        <div class="text-container" id="outputContainer">
                            <div id="outputDisplay"></div>
                        </div>
                        <textarea id="outputText" rows="10" placeholder="Results will appear here..." readonly style="display: none;"></textarea>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="replacementCount">0</div>
                        <div class="stat-label">Replacements Made</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="mappingCount">0</div>
                        <div class="stat-label">Active Mappings</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Data storage
        let mappingSets = {};
        let currentSetId = null;
        let wildcardSettings = {
            emails: false,
            phones: false
        };
        let mappingsCollapsed = false;
        let persistHighlight = false;
        let sideBySideLayout = false;

        // Initialize app
        function init() {
            loadFromStorage();
            renderMappingSets();
            if (currentSetId && mappingSets[currentSetId]) {
                renderMappingEditor(currentSetId);
            } else {
                renderEmptyEditor();
            }
            loadWildcardSettings();
            updateMappingsCollapseState();
            loadPersistHighlightSetting();
            loadLayoutSetting();
        }

        // Storage functions
        function loadFromStorage() {
            const stored = localStorage.getItem('promptSanitizerData');
            if (stored) {
                const data = JSON.parse(stored);
                mappingSets = data.mappingSets || {};
                currentSetId = data.currentSetId || null;
                wildcardSettings = data.wildcardSettings || { emails: false, phones: false };
                mappingsCollapsed = data.mappingsCollapsed || false;
                persistHighlight = data.persistHighlight || false;
                sideBySideLayout = data.sideBySideLayout || false;
            }
        }

        function saveToStorage() {
            const data = {
                mappingSets: mappingSets,
                currentSetId: currentSetId,
                wildcardSettings: wildcardSettings,
                mappingsCollapsed: mappingsCollapsed,
                persistHighlight: persistHighlight,
                sideBySideLayout: sideBySideLayout
            };
            localStorage.setItem('promptSanitizerData', JSON.stringify(data));
        }

        // Wildcard settings functions
        function loadWildcardSettings() {
            document.getElementById('wildcardEmails').checked = wildcardSettings.emails;
            document.getElementById('wildcardPhones').checked = wildcardSettings.phones;
        }

        function saveWildcardSettings() {
            wildcardSettings.emails = document.getElementById('wildcardEmails').checked;
            wildcardSettings.phones = document.getElementById('wildcardPhones').checked;
            saveToStorage();
        }

        // Persist highlight setting
        function loadPersistHighlightSetting() {
            document.getElementById('persistHighlight').checked = persistHighlight;
        }

        function savePersistHighlightSetting() {
            persistHighlight = document.getElementById('persistHighlight').checked;
            saveToStorage();
        }

        // Layout toggle
        function loadLayoutSetting() {
            document.getElementById('sideBySideLayout').checked = sideBySideLayout;
            applyLayoutSetting();
        }

        function toggleLayout() {
            sideBySideLayout = document.getElementById('sideBySideLayout').checked;
            applyLayoutSetting();
            saveToStorage();
        }

        function applyLayoutSetting() {
            const mainScroll = document.getElementById('mainScroll');
            if (sideBySideLayout) {
                mainScroll.classList.add('side-by-side');
            } else {
                mainScroll.classList.remove('side-by-side');
            }
        }

        // Collapse/expand mappings section
        function toggleMappingsCollapse() {
            mappingsCollapsed = !mappingsCollapsed;
            updateMappingsCollapseState();
            saveToStorage();
        }

        function updateMappingsCollapseState() {
            const content = document.getElementById('mappingsCollapsableContent');
            const icon = document.getElementById('mappingsCollapseIcon');

            if (mappingsCollapsed) {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            } else {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                // Set max-height to allow smooth transition
                content.style.maxHeight = content.scrollHeight + 'px';
            }
        }

        // Render functions
        function renderMappingSets() {
            const container = document.getElementById('mappingSets');
            const setIds = Object.keys(mappingSets);

            if (setIds.length === 0) {
                container.innerHTML = '<div style="color: #999; font-size: 0.9em; padding: 20px 0; text-align: center;">No mapping sets yet.<br>Create one below!</div>';
                return;
            }

            container.innerHTML = setIds.map(id => {
                const set = mappingSets[id];
                const count = set.mappings.length;
                const isActive = id === currentSetId;
                return `
                    <div class="mapping-set-item ${isActive ? 'active' : ''}" onclick="selectSet('${id}')">
                        <div class="mapping-set-name">${set.name}</div>
                        <div class="mapping-set-count">${count} mapping${count !== 1 ? 's' : ''}</div>
                        <button class="btn-delete-set" onclick="event.stopPropagation(); deleteSet('${id}')">√ó</button>
                    </div>
                `;
            }).join('');
        }

        function renderMappingEditor(setId) {
            const container = document.getElementById('mappingEditor');
            const set = mappingSets[setId];

            if (!set || set.mappings.length === 0) {
                container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No mappings yet. Add one below!</div>';
                updateMappingCount();
                updateMappingsCollapseState();
                return;
            }

            container.innerHTML = set.mappings.map((mapping, index) => `
                <div class="mapping-row">
                    <input type="text" class="mapping-input" value="${mapping.original}"
                           onchange="updateMapping(${index}, 'original', this.value)" placeholder="Original text">
                    <span class="arrow">‚Üí</span>
                    <input type="text" class="mapping-input" value="${mapping.replacement}"
                           onchange="updateMapping(${index}, 'replacement', this.value)" placeholder="Replacement">
                    <button class="btn-remove-mapping" onclick="removeMapping(${index})">√ó</button>
                </div>
            `).join('');

            updateMappingCount();
            updateMappingsCollapseState();
        }

        function renderEmptyEditor() {
            const container = document.getElementById('mappingEditor');
            container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Select or create a mapping set to get started</div>';
            updateMappingCount();
        }

        // Set management functions
        function createNewSet() {
            const input = document.getElementById('newSetName');
            const name = input.value.trim();

            if (!name) {
                showToast('Please enter a set name', 'warning');
                return;
            }

            const id = 'set_' + Date.now();
            mappingSets[id] = {
                name: name,
                mappings: []
            };

            currentSetId = id;
            input.value = '';

            saveToStorage();
            renderMappingSets();
            renderMappingEditor(id);
            showToast('‚úì Set created!', 'success');
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const mappings = parseCSV(csvContent);

                    if (mappings.length === 0) {
                        showToast('No valid mappings found in CSV', 'warning');
                        return;
                    }

                    // Create a new mapping set with the CSV filename
                    const fileName = file.name.replace('.csv', '');
                    const id = 'set_' + Date.now();
                    mappingSets[id] = {
                        name: fileName,
                        mappings: mappings
                    };

                    currentSetId = id;
                    saveToStorage();
                    renderMappingSets();
                    renderMappingEditor(id);
                    showToast(`‚úì Imported ${mappings.length} mapping(s) from CSV`, 'success');
                } catch (error) {
                    showToast('Error parsing CSV file', 'error');
                    console.error('CSV parse error:', error);
                }
            };
            reader.readAsText(file);

            // Reset the file input so the same file can be uploaded again
            event.target.value = '';
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
            const mappings = [];

            // Check if first row is a header (contains common header terms)
            let startIndex = 0;
            if (lines.length > 0) {
                const firstLine = lines[0].toLowerCase();
                if (firstLine.includes('original') || firstLine.includes('replacement') ||
                    firstLine.includes('from') || firstLine.includes('to')) {
                    startIndex = 1; // Skip header row
                }
            }

            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i];

                // Parse CSV line, handling quoted values
                const parts = parseCSVLine(line);

                if (parts.length >= 2 && parts[0].trim() && parts[1].trim()) {
                    mappings.push({
                        original: parts[0].trim(),
                        replacement: parts[1].trim()
                    });
                }
            }

            return mappings;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Field separator
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }

            // Add last field
            result.push(current);

            return result;
        }

        function selectSet(id) {
            currentSetId = id;
            saveToStorage();
            renderMappingSets();
            renderMappingEditor(id);
        }

        function deleteSet(id) {
            if (!confirm('Delete this mapping set?')) return;

            delete mappingSets[id];
            if (currentSetId === id) {
                currentSetId = Object.keys(mappingSets)[0] || null;
            }

            saveToStorage();
            renderMappingSets();
            if (currentSetId) {
                renderMappingEditor(currentSetId);
            } else {
                renderEmptyEditor();
            }
            showToast('‚úì Set deleted', 'success');
        }

        // Mapping management functions
        function addMapping() {
            if (!currentSetId) {
                showToast('Please create a mapping set first', 'warning');
                return;
            }

            const currentMappings = mappingSets[currentSetId].mappings;
            const nextRefNumber = currentMappings.length + 1;

            // Insert at the beginning of the array
            mappingSets[currentSetId].mappings.unshift({
                original: '',
                replacement: `{ref ${nextRefNumber}}`
            });

            saveToStorage();
            renderMappingEditor(currentSetId);
        }

        function updateMapping(index, field, value) {
            if (!currentSetId) return;

            mappingSets[currentSetId].mappings[index][field] = value;
            saveToStorage();
            updateMappingCount();
        }

        function removeMapping(index) {
            if (!currentSetId) return;

            mappingSets[currentSetId].mappings.splice(index, 1);
            saveToStorage();
            renderMappingEditor(currentSetId);
        }

        function updateMappingCount() {
            if (!currentSetId || !mappingSets[currentSetId]) {
                document.getElementById('mappingCount').textContent = '0';
                return;
            }

            const validMappings = mappingSets[currentSetId].mappings.filter(m => m.original && m.replacement);
            document.getElementById('mappingCount').textContent = validMappings.length;
        }

        // Sanitization functions
        function getCurrentMappings() {
            if (!currentSetId || !mappingSets[currentSetId]) {
                return [];
            }
            return mappingSets[currentSetId].mappings.filter(m => m.original && m.replacement);
        }

        function sanitize() {
            const inputText = document.getElementById('inputText').value;
            if (!inputText.trim()) {
                showToast('Please enter some text to sanitize', 'warning');
                return;
            }

            const mappings = getCurrentMappings();
            const hasWildcards = wildcardSettings.emails || wildcardSettings.phones;

            if (mappings.length === 0 && !hasWildcards) {
                showToast('Please add at least one complete mapping or enable wildcards', 'warning');
                return;
            }

            let result = inputText;
            let count = 0;
            const highlightClass = persistHighlight ? 'highlight' : 'highlight fade';
            let highlightedInput = escapeHtml(inputText);
            let highlightedResult = escapeHtml(inputText);

            // Process wildcard emails
            if (wildcardSettings.emails) {
                const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
                const matches = result.match(emailRegex);
                if (matches) {
                    count += matches.length;
                    result = result.replace(emailRegex, '[email]');
                    highlightedInput = highlightedInput.replace(emailRegex, `<span class="${highlightClass}">$&</span>`);
                    highlightedResult = highlightedResult.replace(emailRegex, `<span class="${highlightClass}">[email]</span>`);
                }
            }

            // Process wildcard phone numbers (US formats)
            if (wildcardSettings.phones) {
                // Matches formats: (123) 456-7890, 123-456-7890, 123.456.7890, 1234567890
                const phoneRegex = /\b(?:\(\d{3}\)\s?|\d{3}[-.\s]?)\d{3}[-.\s]?\d{4}\b/g;
                const matches = result.match(phoneRegex);
                if (matches) {
                    count += matches.length;
                    result = result.replace(phoneRegex, '[phone]');
                    highlightedInput = highlightedInput.replace(phoneRegex, `<span class="${highlightClass}">$&</span>`);
                    highlightedResult = highlightedResult.replace(phoneRegex, `<span class="${highlightClass}">[phone]</span>`);
                }
            }

            // Process explicit mappings (case insensitive)
            // Sort by length (longest first) to handle overlapping patterns correctly
            const sortedMappings = [...mappings].sort((a, b) => b.original.length - a.original.length);

            for (const mapping of sortedMappings) {
                const regex = new RegExp(escapeRegex(mapping.original), 'gi');
                const matches = result.match(regex);
                if (matches) {
                    count += matches.length;
                    result = result.replace(regex, mapping.replacement);
                    const escapedReplacement = escapeHtml(mapping.replacement);
                    highlightedInput = highlightedInput.replace(
                        new RegExp(escapeRegex(escapeHtml(mapping.original)), 'gi'),
                        `<span class="${highlightClass}">$&</span>`
                    );
                    highlightedResult = highlightedResult.replace(
                        new RegExp(escapeRegex(escapeHtml(mapping.original)), 'gi'),
                        `<span class="${highlightClass}">${escapedReplacement}</span>`
                    );
                }
            }

            document.getElementById('outputText').value = result;
            displayInput(highlightedInput);
            displayOutput(highlightedResult);
            document.getElementById('replacementCount').textContent = count;
            showToast(`‚úì Sanitized! ${count} replacement(s) made`, 'success');
        }

        function desanitize() {
            const inputText = document.getElementById('inputText').value;
            if (!inputText.trim()) {
                showToast('Please enter some text to desanitize', 'warning');
                return;
            }

            const mappings = getCurrentMappings();
            if (mappings.length === 0) {
                showToast('Please add at least one complete mapping', 'warning');
                return;
            }

            let result = inputText;
            let count = 0;
            const highlightClass = persistHighlight ? 'highlight' : 'highlight fade';
            let highlightedInput = escapeHtml(inputText);
            let highlightedResult = escapeHtml(inputText);

            for (const mapping of mappings) {
                const regex = new RegExp(escapeRegex(mapping.replacement), 'g');
                const matches = result.match(regex);
                if (matches) {
                    count += matches.length;
                    result = result.replace(regex, mapping.original);
                    const escapedOriginal = escapeHtml(mapping.original);
                    highlightedInput = highlightedInput.replace(
                        new RegExp(escapeRegex(escapeHtml(mapping.replacement)), 'g'),
                        `<span class="${highlightClass}">$&</span>`
                    );
                    highlightedResult = highlightedResult.replace(
                        new RegExp(escapeRegex(escapeHtml(mapping.replacement)), 'g'),
                        `<span class="${highlightClass}">${escapedOriginal}</span>`
                    );
                }
            }

            document.getElementById('outputText').value = result;
            displayInput(highlightedInput);
            displayOutput(highlightedResult);
            document.getElementById('replacementCount').textContent = count;
            showToast(`‚úì Desanitized! ${count} replacement(s) made`, 'success');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function displayInput(htmlContent) {
            const inputDisplay = document.getElementById('inputDisplay');
            const inputTextarea = document.getElementById('inputText');
            const inputContainer = document.getElementById('inputContainer');

            if (htmlContent && htmlContent.trim()) {
                inputDisplay.innerHTML = htmlContent;
                inputDisplay.style.display = 'block';
                inputTextarea.style.display = 'none';
                // Match the container height to the textarea's previous height
                const textareaHeight = inputTextarea.offsetHeight;
                if (textareaHeight > 0) {
                    inputContainer.style.height = textareaHeight + 'px';
                }
            } else {
                inputDisplay.style.display = 'none';
                inputTextarea.style.display = 'block';
                inputContainer.style.height = '';
            }
        }

        function displayOutput(htmlContent) {
            const outputDisplay = document.getElementById('outputDisplay');
            const outputContainer = document.getElementById('outputContainer');
            outputDisplay.innerHTML = htmlContent || '<span style="color: #999;">Results will appear here...</span>';

            // Match the output container height to input container if needed
            const inputContainer = document.getElementById('inputContainer');
            if (inputContainer && inputContainer.style.height) {
                outputContainer.style.height = inputContainer.style.height;
            }
        }

        function copyOutput() {
            const output = document.getElementById('outputText').value;
            if (!output.trim()) {
                showToast('Nothing to copy', 'warning');
                return;
            }

            navigator.clipboard.writeText(output).then(() => {
                showToast('‚úì Copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        function clearAll() {
            document.getElementById('inputText').value = '';
            document.getElementById('outputText').value = '';
            displayInput('');
            displayOutput('');
            document.getElementById('replacementCount').textContent = '0';
            showToast('‚úì Cleared all fields', 'success');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            
            if (type === 'warning') {
                toast.style.background = '#985fb9';
                toast.style.color = '#fff';
            } else if (type === 'error') {
                toast.style.background = '#415169';
                toast.style.color = '#fff';
            } else {
                toast.style.background = '#71a9bf';
                toast.style.color = '#fff';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize on load
        init();
    </script>
</body>
</html>